<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üôè Japa Counter - Spiritual Mantra Counter</title>
    <meta name="description" content="Complete spiritual counting companion for mantra japa practice with 108 beads counter">
    <meta name="theme-color" content="#ea580c">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
            animation: spin-slow 3s linear infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Lucide icons as inline SVG components
        const RotateCcw = ({size = 24}) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                <path d="M3 3v5h5"/>
            </svg>
        );
        
        const Plus = ({size = 24}) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
        );
        
        const Edit3 = ({size = 24}) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M12 20h9"/>
                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
            </svg>
        );
        
        const BookOpen = ({size = 24}) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
            </svg>
        );
        
        const Heart = ({size = 24, fill = "none"}) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
            </svg>
        );
        
        const Star = ({size = 24}) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
            </svg>
        );
        
        const Volume2 = ({size = 24}) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
            </svg>
        );
        
        const VolumeX = ({size = 24}) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                <line x1="23" y1="9" x2="17" y2="15"/>
                <line x1="17" y1="9" x2="23" y2="15"/>
            </svg>
        );
        
        const Award = ({size = 24}) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="8" r="7"/>
                <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/>
            </svg>
        );
        
        const Clock = ({size = 24}) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
            </svg>
        );
        
        const Target = ({size = 24}) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <circle cx="12" cy="12" r="6"/>
                <circle cx="12" cy="12" r="2"/>
            </svg>
        );
        
        const Moon = ({size = 24}) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
            </svg>
        );
        
        const Sun = ({size = 24}) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="5"/>
                <line x1="12" y1="1" x2="12" y2="3"/>
                <line x1="12" y1="21" x2="12" y2="23"/>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                <line x1="1" y1="12" x2="3" y2="12"/>
                <line x1="21" y1="12" x2="23" y2="12"/>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
            </svg>
        );
        
        const Sparkles = ({size = 24}) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/>
                <path d="M5 3v4"/>
                <path d="M19 17v4"/>
                <path d="M3 5h4"/>
                <path d="M17 19h4"/>
            </svg>
        );
        
        const TrendingUp = ({size = 24}) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                <polyline points="17 6 23 6 23 12"/>
            </svg>
        );

        function JapaCounter() {
          const [count, setCount] = useState(0);
          const [rounds, setRounds] = useState(0);
          const [totalCount, setTotalCount] = useState(0);
          const [selectedMantra, setSelectedMantra] = useState('');
          const [customMantra, setCustomMantra] = useState('');
          const [showMantraInput, setShowMantraInput] = useState(false);
          const [favorites, setFavorites] = useState([]);
          const [displaySize, setDisplaySize] = useState('medium');
          const [soundEnabled, setSoundEnabled] = useState(true);
          const [mantraCategory, setMantraCategory] = useState('popular');
          const [isAnimating, setIsAnimating] = useState(false);
          const [theme, setTheme] = useState('light');
          const [sessionStartTime, setSessionStartTime] = useState(null);
          const [dailyGoal, setDailyGoal] = useState(108);
          const [showStats, setShowStats] = useState(false);
          const [achievements, setAchievements] = useState([]);
          const [breathingMode, setBreathingMode] = useState(false);
          const [motivationalQuote, setMotivationalQuote] = useState('');
          const [sessionHistory, setSessionHistory] = useState([]);
          const [customMantras, setCustomMantras] = useState([]);
          const [lotusAnimation, setLotusAnimation] = useState(false);
          const [dbReady, setDbReady] = useState(false);
          const [storageMode, setStorageMode] = useState('pending');
          const [installPromptEvent, setInstallPromptEvent] = useState(null);

          const mantraCategories = {
            popular: [
              'Om Namah Shivaya',
              'Hare Krishna Hare Krishna Krishna Krishna Hare Hare',
              'Om Mani Padme Hum',
              'So Hum',
              'Ram Ram',
              'Om Gam Ganapataye Namaha'
            ],
            gayatri: [
              'Om Bhur Bhuva Swaha Tat Savitur Varenyam Bhargo Devasya Dhimahi Dhiyo Yo Nah Prachodayat',
              'Gayatri Mantra (Short Form)',
              'Om Tat Sat'
            ],
            vishnu: [
              'Om Namo Narayanaya',
              'Om Namo Bhagavate Vasudevaya',
              'Hare Rama Hare Rama Rama Rama Hare Hare',
              'Sri Rama Jayam',
              'Om Kleem Krishnaya Namaha'
            ],
            shiva: [
              'Om Namah Shivaya',
              'Har Har Mahadev',
              'Om Tryambakam Yajamahe',
              'Shivo Hum',
              'Om Hreem Namah Shivaya'
            ],
            devi: [
              'Om Aim Hreem Kleem Chamundaye Vichche',
              'Om Dum Durgayei Namaha',
              'Om Shreem Mahalakshmyai Namaha',
              'Om Gan Ganapataye Namaha',
              'Jai Ma Durga'
            ],
            kali: [
              'Om Krim Kalikaye Namaha',
              'Om Kleem Kalika-Yei Namaha',
              'Om Hrim Shreem Klim Adya Kalika Param Eshwari Swaha',
              'Kring Kring Kring Hing Hing Hum Hum Dakshine Kalike Kring Kring Kring Hum Hum Hrim Hrim Swaha',
              'Om Mahakali Mahakali Raksha Mam Swaha',
              'Om Aim Hrim Klim Chamundayei Vichche',
              'Jai Ma Kali Jai Ma Durga',
              'Om Kali Ma',
              'Krim Krim Krim Hum Hum Hrim Hrim Dakshine Kalike'
            ],
            bhairava: [
              'Om Hreem Ksham Bhairavaya Namaha',
              'Om Kala Bhairavaya Namaha',
              'Om Batukaya Apaduddharanaaya Kuru Kuru Batukaya Hreem',
              'Om Bhram Bhreem Bhroum Sah Bhairavaya Namaha',
              'Om Kaalabhairavaya Vidmahe Kalaatheethaaya Dheemahi Tanno Bhairo Prachodayath',
              'Om Asithaangaya Vidmahe Soolahasthaaya Dheemahi Tanno Bhairo Prachodayath',
              'Om Bhairavaya Swaha',
              'Om Kala Kala Maha Kala Kaleshwaraya Namaha',
              'Om Batuk Bhairavaya Namaha'
            ],
            buddhist: [
              'Om Mani Padme Hum',
              'Gate Gate Paragate Parasamgate Bodhi Svaha',
              'Om Tare Tuttare Ture Svaha',
              'Namo Amitabha Buddha',
              'Om Ami Dewa Hrih'
            ],
            peace: [
              'Om Shanti Shanti Shanti',
              'Lokah Samastah Sukhino Bhavantu',
              'Om Sarvesham Svastir Bhavatu',
              'Om Dyauh Shantirantariksham Shanti',
              'Asato Ma Sad Gamaya'
            ],
            healing: [
              'Om Gam Ganapataye Namaha (Obstacle Removal)',
              'Om Trayambakam Yajamahe (Healing)',
              'Om Hraam Hreem Hraum Sah Suryaya Namaha',
              'Om Dhanvantri Namaha',
              'Ra Ma Da Sa Sa Say So Hum'
            ]
          };

          const motivationalQuotes = [
            "The mind is everything. What you think you become.",
            "Yoga is the journey of the self, through the self, to the self.",
            "When you practice gratitude, there is a sense of respect toward others.",
            "The soul is neither born, and nor does it die.",
            "Meditation brings wisdom; lack of meditation leaves ignorance.",
            "In the practice of tolerance, one's enemy is the best teacher.",
            "The body is your temple. Keep it pure and clean."
          ];

          // IndexedDB Setup
          const DB_NAME = 'JapaCounterDB';
          const DB_VERSION = 1;
          const LOCAL_STORAGE_KEYS = {
            customMantras: 'japa_custom_mantras',
            favorites: 'japa_favorites'
          };
          let db = null;

          const supportsIndexedDB = () => {
            try {
              return typeof window !== 'undefined' && !!window.indexedDB;
            } catch (error) {
              console.warn('IndexedDB check failed:', error);
              return false;
            }
          };

          const loadFromLocalStorage = (key) => {
            if (typeof window === 'undefined' || !window.localStorage) {
              return [];
            }
            try {
              const raw = window.localStorage.getItem(key);
              return raw ? JSON.parse(raw) : [];
            } catch (error) {
              console.error('Failed to read from localStorage:', error);
              return [];
            }
          };

          const saveToLocalStorage = (key, value) => {
            if (typeof window === 'undefined' || !window.localStorage) {
              return;
            }
            try {
              window.localStorage.setItem(key, JSON.stringify(value));
            } catch (error) {
              console.error('Failed to persist to localStorage:', error);
            }
          };

          const requestToPromise = (request) => {
            return new Promise((resolve, reject) => {
              request.onsuccess = () => resolve(request.result);
              request.onerror = () => reject(request.error);
            });
          };

          const openDatabase = () => {
            if (!supportsIndexedDB()) {
              return Promise.reject(new Error('IndexedDB is not available in this browser'));
            }

            return new Promise((resolve, reject) => {
              const request = indexedDB.open(DB_NAME, DB_VERSION);

              request.onerror = () => {
                console.error('Database failed to open');
                reject(request.error);
              };

              request.onsuccess = () => {
                db = request.result;
                console.log('Database opened successfully');
                resolve(db);
              };

              request.onupgradeneeded = (e) => {
                db = e.target.result;
                
                if (!db.objectStoreNames.contains('customMantras')) {
                  const customMantrasStore = db.createObjectStore('customMantras', { keyPath: 'id', autoIncrement: true });
                  customMantrasStore.createIndex('mantra', 'mantra', { unique: false });
                }
                
                if (!db.objectStoreNames.contains('favorites')) {
                  db.createObjectStore('favorites', { keyPath: 'mantra' });
                }
                
                console.log('Database setup complete');
              };
            });
          };

          const saveCustomMantraDB = (mantra) => {
            if (!mantra) {
              return Promise.resolve();
            }

            if (storageMode === 'localStorage' || !supportsIndexedDB()) {
              const stored = loadFromLocalStorage(LOCAL_STORAGE_KEYS.customMantras);
              if (!stored.includes(mantra)) {
                saveToLocalStorage(LOCAL_STORAGE_KEYS.customMantras, [...stored, mantra]);
              }
              return Promise.resolve();
            }

            return new Promise((resolve, reject) => {
              if (!db) {
                reject(new Error('Database is not ready'));
                return;
              }

              const transaction = db.transaction(['customMantras'], 'readwrite');
              const store = transaction.objectStore('customMantras');

              transaction.onerror = () => {
                console.error('Transaction failed while saving custom mantra');
                reject(transaction.error);
              };

              requestToPromise(store.add({ mantra: mantra, createdAt: new Date().toISOString() }))
                .then(() => {
                  console.log('Custom mantra saved:', mantra);
                  resolve();
                })
                .catch((error) => {
                  console.error('Error saving custom mantra');
                  reject(error);
                });
            });
          };

          const loadCustomMantrasDB = () => {
            if (storageMode === 'localStorage' || !supportsIndexedDB() || !db) {
              const stored = loadFromLocalStorage(LOCAL_STORAGE_KEYS.customMantras);
              console.log('Custom mantras loaded from localStorage:', stored);
              return Promise.resolve(stored);
            }

            return new Promise((resolve, reject) => {
              const transaction = db.transaction(['customMantras'], 'readonly');
              const store = transaction.objectStore('customMantras');

              transaction.onerror = () => {
                console.error('Transaction failed while loading custom mantras');
                reject(transaction.error);
              };

              requestToPromise(store.getAll())
                .then((result) => {
                  const mantras = result.map(item => item.mantra);
                  console.log('Custom mantras loaded:', mantras);
                  resolve(mantras);
                })
                .catch((error) => {
                  console.error('Error loading custom mantras');
                  reject(error);
                });
            });
          };

          const saveFavoritesDB = (favoritesList) => {
            if (storageMode === 'localStorage' || !supportsIndexedDB()) {
              saveToLocalStorage(LOCAL_STORAGE_KEYS.favorites, favoritesList);
              console.log('Favorites saved to localStorage:', favoritesList);
              return Promise.resolve();
            }

            return new Promise((resolve, reject) => {
              if (!db) {
                reject(new Error('Database is not ready'));
                return;
              }

              const transaction = db.transaction(['favorites'], 'readwrite');
              const store = transaction.objectStore('favorites');
              let settled = false;

              const finish = () => {
                if (settled) return;
                settled = true;
                console.log('Favorites saved:', favoritesList);
                resolve();
              };

              const fail = (error) => {
                if (settled) return;
                settled = true;
                console.error('Error saving favorites');
                reject(error);
              };

              transaction.oncomplete = finish;
              transaction.onerror = () => fail(transaction.error);

              requestToPromise(store.clear())
                .then(() => {
                  const ops = favoritesList.map((fav) => requestToPromise(store.put({ mantra: fav })));
                  return Promise.all(ops);
                })
                .catch(fail);
            });
          };

          const loadFavoritesDB = () => {
            if (storageMode === 'localStorage' || !supportsIndexedDB() || !db) {
              const stored = loadFromLocalStorage(LOCAL_STORAGE_KEYS.favorites);
              console.log('Favorites loaded from localStorage:', stored);
              return Promise.resolve(stored);
            }

            return new Promise((resolve, reject) => {
              const transaction = db.transaction(['favorites'], 'readonly');
              const store = transaction.objectStore('favorites');

              transaction.onerror = () => {
                console.error('Transaction failed while loading favorites');
                reject(transaction.error);
              };

              requestToPromise(store.getAll())
                .then((result) => {
                  const favs = result.map(item => item.mantra);
                  console.log('Favorites loaded:', favs);
                  resolve(favs);
                })
                .catch((error) => {
                  console.error('Error loading favorites');
                  reject(error);
                });
            });
          };

          useEffect(() => {
            if ('serviceWorker' in navigator) {
              navigator.serviceWorker.register('./service-worker.js').catch((error) => {
                console.error('Service worker registration failed:', error);
              });
            }
          }, []);

          useEffect(() => {
            const beforeInstallHandler = (event) => {
              event.preventDefault();
              setInstallPromptEvent(event);
            };

            const installedHandler = () => {
              setInstallPromptEvent(null);
            };

            window.addEventListener('beforeinstallprompt', beforeInstallHandler);
            window.addEventListener('appinstalled', installedHandler);

            if (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) {
              setInstallPromptEvent(null);
            }

            return () => {
              window.removeEventListener('beforeinstallprompt', beforeInstallHandler);
              window.removeEventListener('appinstalled', installedHandler);
            };
          }, []);

          useEffect(() => {
            const initStorage = async () => {
              if (supportsIndexedDB()) {
                try {
                  await openDatabase();
                  setStorageMode('indexeddb');
                  setDbReady(true);

                  const loadedCustomMantras = await loadCustomMantrasDB();
                  const loadedFavorites = await loadFavoritesDB();

                  setCustomMantras(loadedCustomMantras);
                  setFavorites(loadedFavorites);
                  return;
                } catch (error) {
                  console.error('Error initializing IndexedDB. Falling back to localStorage.', error);
                }
              }

              const storedCustomMantras = loadFromLocalStorage(LOCAL_STORAGE_KEYS.customMantras);
              const storedFavorites = loadFromLocalStorage(LOCAL_STORAGE_KEYS.favorites);
              setStorageMode('localStorage');
              setDbReady(true);
              setCustomMantras(storedCustomMantras);
              setFavorites(storedFavorites);
            };

            initStorage();
            setMotivationalQuote(motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)]);
          }, []);

          useEffect(() => {
            if (count === 1 && !sessionStartTime) {
              setSessionStartTime(Date.now());
            }
          }, [count]);

          useEffect(() => {
            checkAchievements();
          }, [totalCount, rounds]);

          const checkAchievements = () => {
            const newAchievements = [];
            
            if (rounds >= 1 && !achievements.includes('first_round')) {
              newAchievements.push({ id: 'first_round', title: 'First Steps', desc: 'Complete your first 108 round' });
            }
            if (rounds >= 10 && !achievements.includes('dedicated')) {
              newAchievements.push({ id: 'dedicated', title: 'Dedicated Soul', desc: 'Complete 10 rounds' });
            }
            if (rounds >= 50 && !achievements.includes('master')) {
              newAchievements.push({ id: 'master', title: 'Master Practitioner', desc: 'Complete 50 rounds' });
            }
            if (totalCount >= 1000 && !achievements.includes('thousand')) {
              newAchievements.push({ id: 'thousand', title: 'Thousand Lights', desc: 'Count 1000 mantras' });
            }
            
            if (newAchievements.length > 0) {
              setAchievements([...achievements, ...newAchievements.map(a => a.id)]);
            }
          };

          const playSound = () => {
            if (soundEnabled) {
              const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEcCCeJzfDCeBwQK4fI7tiRPwkSWq3r6qFTGAhJrtv51NfCeQ==');
              audio.volume = 0.3;
              audio.play().catch(() => {});
            }
          };

          const increment = () => {
            const newCount = count + 1;
            const newTotalCount = totalCount + 1;
            
            playSound();
            setIsAnimating(true);
            
            setTimeout(() => setIsAnimating(false), 300);
            
            if (newCount === 108) {
              setCount(0);
              setRounds(rounds + 1);
              setTotalCount(newTotalCount);
              
              setLotusAnimation(true);
              setTimeout(() => setLotusAnimation(false), 3000);
              
              const sessionTime = sessionStartTime ? Math.floor((Date.now() - sessionStartTime) / 1000 / 60) : 0;
              setSessionHistory([...sessionHistory, { 
                mantra: selectedMantra, 
                time: new Date().toLocaleTimeString(),
                duration: sessionTime
              }]);
              setSessionStartTime(Date.now());
            } else {
              setCount(newCount);
              setTotalCount(newTotalCount);
            }
          };

          const reset = () => {
            setCount(0);
            setRounds(0);
            setTotalCount(0);
            setSessionStartTime(null);
          };

          const handleMantraSelect = (mantra) => {
            if (mantra === 'Custom Mantra') {
              setShowMantraInput(true);
              setSelectedMantra('');
            } else {
              setSelectedMantra(mantra);
              setShowMantraInput(false);
            }
          };

          const handleCustomMantraSubmit = async () => {
            if (customMantra.trim() && dbReady) {
              setSelectedMantra(customMantra);
              setShowMantraInput(false);
              
              if (!customMantras.includes(customMantra.trim())) {
                try {
                  await saveCustomMantraDB(customMantra.trim());
                  const updated = await loadCustomMantrasDB();
                  setCustomMantras(updated);
                } catch (error) {
                  console.error('Failed to save custom mantra:', error);
                }
              }
            }
          };

          const toggleFavorite = async (mantra) => {
            let newFavorites;
            if (favorites.includes(mantra)) {
              newFavorites = favorites.filter(fav => fav !== mantra);
            } else {
              newFavorites = [...favorites, mantra];
            }
            
            setFavorites(newFavorites);
            
            if (dbReady) {
              try {
                await saveFavoritesDB(newFavorites);
              } catch (error) {
                console.error('Failed to save favorites:', error);
              }
            }
          };

          const getCurrentMantra = () => {
            return selectedMantra || customMantra || 'Select a mantra to begin your spiritual practice';
          };

          const progress = (count / 108) * 100;
          const goalProgress = (totalCount / dailyGoal) * 100;

          const getDisplayClasses = () => {
            switch(displaySize) {
              case 'small': return 'text-base';
              case 'large': return 'text-xl';
              default: return 'text-lg';
            }
          };

          const getCurrentMantras = () => {
            const categoryMantras = mantraCategories[mantraCategory] || [];
            return [...categoryMantras, ...customMantras, 'Custom Mantra'];
          };

          const handleInstallClick = async () => {
            if (!installPromptEvent) {
              return;
            }
            installPromptEvent.prompt();
            try {
              const { outcome } = await installPromptEvent.userChoice;
              if (outcome === 'accepted') {
                setInstallPromptEvent(null);
              }
            } catch (error) {
              console.error('Install prompt failed:', error);
            }
          };

          const getSessionDuration = () => {
            if (!sessionStartTime) return '0m';
            const minutes = Math.floor((Date.now() - sessionStartTime) / 1000 / 60);
            return `${minutes}m`;
          };

          const themeColors = theme === 'dark' 
            ? 'from-slate-800 to-slate-900' 
            : 'from-orange-50 to-amber-100';
          
          const cardBg = theme === 'dark' ? 'bg-slate-700' : 'bg-white';
          const textPrimary = theme === 'dark' ? 'text-orange-300' : 'text-orange-800';
          const textSecondary = theme === 'dark' ? 'text-orange-400' : 'text-orange-600';

          return (
            <div className={`min-h-screen bg-gradient-to-br ${themeColors} flex items-center justify-center p-4`}>
              <div className={`${cardBg} rounded-3xl shadow-2xl p-6 w-full max-w-lg text-center relative overflow-hidden`}>
                
                {breathingMode && (
                  <div className="absolute inset-0 pointer-events-none z-0">
                    <div className="w-full h-full bg-gradient-to-r from-blue-200/20 to-purple-200/20 animate-pulse"></div>
                  </div>
                )}

                {lotusAnimation && (
                  <div className="absolute inset-0 pointer-events-none z-50 flex items-center justify-center bg-gradient-to-r from-pink-500/20 via-purple-500/20 to-orange-500/20 backdrop-blur-sm">
                    <div className="relative flex flex-col items-center">
                      <div className="text-9xl animate-bounce">ü™∑</div>
                      
                      <div className="absolute inset-0 flex items-center justify-center">
                        <div className="w-40 h-40 rounded-full bg-pink-400/30 animate-ping"></div>
                      </div>
                      <div className="absolute inset-0 flex items-center justify-center animation-delay-150">
                        <div className="w-32 h-32 rounded-full bg-purple-400/30 animate-ping"></div>
                      </div>
                      
                      <div className="mt-6 text-3xl font-bold text-white drop-shadow-2xl animate-pulse">
                        üéâ 108 Complete! üéâ
                      </div>
                      <div className="mt-2 text-lg text-white/90 drop-shadow-lg">
                        Round {rounds} finished beautifully
                      </div>
                    </div>
                  </div>
                )}

                <div className="relative z-10">
                  <div className="flex justify-between items-center mb-4">
                    <div className="flex-1">
                      <h1 className={`text-3xl font-bold ${textPrimary} mb-2`}>üôè Japa Counter</h1>
                      <p className={textSecondary}>Complete spiritual counting companion</p>
                    </div>
                    <div className="flex items-center gap-2">
                      {installPromptEvent && (
                        <button
                          onClick={handleInstallClick}
                          className="bg-green-500 hover:bg-green-600 text-white text-xs font-semibold px-3 py-2 rounded-lg shadow-sm transition-transform hover:scale-105"
                        >
                          Install App
                        </button>
                      )}
                      <button
                        onClick={() => setTheme(theme === 'light' ? 'dark' : 'light')}
                        className={`${textSecondary} hover:scale-110 transition-transform`}
                      >
                        {theme === 'light' ? <Moon size={24} /> : <Sun size={24} />}
                      </button>
                    </div>
                  </div>

                  <div className={`flex justify-between items-center mb-4 ${theme === 'dark' ? 'bg-slate-600' : 'bg-orange-50'} rounded-xl p-3`}>
                    <div className="flex items-center gap-2">
                      <label className={`text-sm ${textSecondary}`}>Size:</label>
                      <select 
                        value={displaySize}
                        onChange={(e) => setDisplaySize(e.target.value)}
                        className="text-xs border border-orange-200 rounded p-1"
                      >
                        <option value="small">Small</option>
                        <option value="medium">Medium</option>
                        <option value="large">Large</option>
                      </select>
                    </div>
                    <div className="flex gap-2">
                      <button
                        onClick={() => setBreathingMode(!breathingMode)}
                        className={`${breathingMode ? 'text-blue-500' : textSecondary} hover:scale-110 transition-all`}
                        title="Breathing Mode"
                      >
                        <Sparkles size={18} />
                      </button>
                      <button
                        onClick={() => setSoundEnabled(!soundEnabled)}
                        className={`${textSecondary} hover:scale-110 transition-all`}
                      >
                        {soundEnabled ? <Volume2 size={18} /> : <VolumeX size={18} />}
                      </button>
                    </div>
                  </div>

                  <div className={`mb-4 p-3 ${theme === 'dark' ? 'bg-slate-600' : 'bg-gradient-to-r from-green-50 to-emerald-50'} rounded-xl border ${theme === 'dark' ? 'border-slate-500' : 'border-green-200'}`}>
                    <div className="flex justify-between items-center mb-2">
                      <div className={`text-sm font-medium ${theme === 'dark' ? 'text-green-300' : 'text-green-700'} flex items-center gap-1`}>
                        <Target size={16} />
                        Daily Goal: {totalCount}/{dailyGoal}
                      </div>
                      <input 
                        type="number" 
                        value={dailyGoal}
                        onChange={(e) => setDailyGoal(Math.max(108, parseInt(e.target.value) || 108))}
                        className="w-20 text-xs p-1 border rounded"
                        min="108"
                        step="108"
                      />
                    </div>
                    <div className="w-full bg-gray-200 rounded-full h-2">
                      <div 
                        className="bg-green-500 h-2 rounded-full transition-all duration-500"
                        style={{ width: `${Math.min(goalProgress, 100)}%` }}
                      ></div>
                    </div>
                  </div>

                  {motivationalQuote && (
                    <div className={`mb-4 p-3 ${theme === 'dark' ? 'bg-slate-600' : 'bg-purple-50'} border ${theme === 'dark' ? 'border-slate-500' : 'border-purple-200'} rounded-xl`}>
                      <p className={`text-xs italic ${theme === 'dark' ? 'text-purple-300' : 'text-purple-700'}`}>
                        {motivationalQuote}
                      </p>
                    </div>
                  )}

                  <div className="mb-4">
                    <div className={`${theme === 'dark' ? 'bg-slate-600' : 'bg-gradient-to-r from-orange-50 to-amber-50'} rounded-xl p-4 mb-3 border ${theme === 'dark' ? 'border-slate-500' : 'border-orange-100'}`}>
                      <div className={`text-sm ${textSecondary} mb-2 font-medium flex items-center gap-1 justify-center`}>
                        <BookOpen size={16} />
                        Current Mantra:
                      </div>
                      <div className={`font-semibold ${textPrimary} break-words leading-relaxed ${getDisplayClasses()}`}>
                        {getCurrentMantra()}
                      </div>
                      {selectedMantra && (
                        <button
                          onClick={() => toggleFavorite(selectedMantra)}
                          className={`mt-2 text-sm flex items-center gap-1 mx-auto transition-colors ${
                            favorites.includes(selectedMantra) 
                              ? 'text-red-500 hover:text-red-600' 
                              : 'text-gray-400 hover:text-red-400'
                          }`}
                        >
                          <Heart size={14} fill={favorites.includes(selectedMantra) ? 'currentColor' : 'none'} />
                          {favorites.includes(selectedMantra) ? 'Favorited' : 'Add to Favorites'}
                        </button>
                      )}
                    </div>
                    
                    <div className="mb-3">
                      <label className={`text-sm ${textSecondary} block mb-2`}>Mantra Category:</label>
                      <select 
                        value={mantraCategory}
                        onChange={(e) => setMantraCategory(e.target.value)}
                        className="w-full p-2 border border-orange-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-400 bg-white text-gray-700 text-sm"
                      >
                        <option value="popular">Popular Mantras</option>
                        <option value="gayatri">Gayatri & Vedic</option>
                        <option value="vishnu">Vishnu Mantras</option>
                        <option value="shiva">Shiva Mantras</option>
                        <option value="devi">Devi/Goddess Mantras</option>
                        <option value="kali">Kali Mata Mantras</option>
                        <option value="bhairava">Kala Bhairava Mantras</option>
                        <option value="buddhist">Buddhist Mantras</option>
                        <option value="peace">Peace & Universal</option>
                        <option value="healing">Healing Mantras</option>
                      </select>
                    </div>
                    
                    {!showMantraInput ? (
                      <div>
                        <select 
                          value={selectedMantra}
                          onChange={(e) => handleMantraSelect(e.target.value)}
                          className="w-full p-3 border border-orange-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-400 bg-white text-gray-700 mb-2"
                        >
                          <option value="">Choose a mantra...</option>
                          {favorites.length > 0 && (
                            <optgroup label="‚≠ê Your Favorites">
                              {favorites.map((mantra, index) => (
                                <option key={`fav-${index}`} value={mantra}>{mantra}</option>
                              ))}
                            </optgroup>
                          )}
                          {customMantras.length > 0 && (
                            <optgroup label="üìù Your Custom Mantras">
                              {customMantras.map((mantra, index) => (
                                <option key={`custom-${index}`} value={mantra}>{mantra}</option>
                              ))}
                            </optgroup>
                          )}
                          <optgroup label={`üìø ${mantraCategory.charAt(0).toUpperCase() + mantraCategory.slice(1)} Mantras`}>
                            {mantraCategories[mantraCategory].map((mantra, index) => (
                              <option key={index} value={mantra}>{mantra}</option>
                            ))}
                            <option value="Custom Mantra">+ Add Custom Mantra</option>
                          </optgroup>
                        </select>
                      </div>
                    ) : (
                      <div className="space-y-2">
                        <textarea
                          placeholder="Enter your custom mantra..."
                          value={customMantra}
                          onChange={(e) => setCustomMantra(e.target.value)}
                          className="w-full p-3 border border-orange-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-400 resize-none h-20"
                        />
                        <div className="flex gap-2">
                          <button
                            onClick={handleCustomMantraSubmit}
                            className="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg text-sm hover:bg-orange-600 transition-colors"
                          >
                            Save Mantra
                          </button>
                          <button
                            onClick={() => {setShowMantraInput(false); setCustomMantra('');}}
                            className="bg-gray-400 text-white py-2 px-4 rounded-lg text-sm hover:bg-gray-500 transition-colors"
                          >
                            Cancel
                          </button>
                        </div>
                      </div>
                    )}
                    
                    {selectedMantra && !showMantraInput && (
                      <button
                        onClick={() => {setShowMantraInput(true); setCustomMantra(selectedMantra);}}
                        className={`${textSecondary} text-sm hover:${textPrimary} flex items-center gap-1 mt-2 mx-auto transition-colors`}
                      >
                        <Edit3 size={14} />
                        Edit mantra
                      </button>
                    )}
                  </div>

                  <div className="relative mb-4">
                    <div className={`w-36 h-36 mx-auto relative transition-transform duration-200 ${isAnimating ? 'scale-110' : 'scale-100'}`}>
                      <svg className="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                        <circle
                          cx="50"
                          cy="50"
                          r="45"
                          fill="none"
                          stroke={theme === 'dark' ? '#475569' : '#fed7aa'}
                          strokeWidth="8"
                        />
                        <circle
                          cx="50"
                          cy="50"
                          r="45"
                          fill="none"
                          stroke="#ea580c"
                          strokeWidth="8"
                          strokeLinecap="round"
                          strokeDasharray={`${2 * Math.PI * 45}`}
                          strokeDashoffset={`${2 * Math.PI * 45 * (1 - progress / 100)}`}
                          className="transition-all duration-300 ease-out"
                        />
                      </svg>
                      <div className="absolute inset-0 flex items-center justify-center">
                        <div>
                          <div className={`text-3xl font-bold ${textPrimary} mb-1 transition-all duration-300 ${isAnimating ? 'scale-125 text-orange-600' : 'scale-100'}`}>
                            {count}
                          </div>
                          <div className={`text-sm ${textSecondary}`}>of 108</div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div className="grid grid-cols-4 gap-2 mb-4">
                    <div className={`${theme === 'dark' ? 'bg-slate-600' : 'bg-orange-50'} rounded-xl p-3`}>
                      <div className={`text-xl font-bold ${textPrimary}`}>{rounds}</div>
                      <div className={`text-xs ${textSecondary}`}>Rounds</div>
                    </div>
                    <div className={`${theme === 'dark' ? 'bg-slate-600' : 'bg-amber-50'} rounded-xl p-3`}>
                      <div className={`text-xl font-bold ${theme === 'dark' ? 'text-amber-300' : 'text-amber-800'}`}>{totalCount}</div>
                      <div className={`text-xs ${theme === 'dark' ? 'text-amber-400' : 'text-amber-600'}`}>Total</div>
                    </div>
                    <div className={`${theme === 'dark' ? 'bg-slate-600' : 'bg-green-50'} rounded-xl p-3`}>
                      <div className={`text-xl font-bold ${theme === 'dark' ? 'text-green-300' : 'text-green-800'}`}>{Math.floor(progress)}%</div>
                      <div className={`text-xs ${theme === 'dark' ? 'text-green-400' : 'text-green-600'}`}>Progress</div>
                    </div>
                    <div className={`${theme === 'dark' ? 'bg-slate-600' : 'bg-blue-50'} rounded-xl p-3`}>
                      <div className={`text-xl font-bold ${theme === 'dark' ? 'text-blue-300' : 'text-blue-800'}`}>
                        <Clock size={16} className="inline" />
                      </div>
                      <div className={`text-xs ${theme === 'dark' ? 'text-blue-400' : 'text-blue-600'}`}>{getSessionDuration()}</div>
                    </div>
                  </div>

                  <div className="flex gap-3 mb-4">
                    <button
                      onClick={increment}
                      className="flex-1 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-200 flex items-center justify-center gap-2 text-lg active:scale-95 transform shadow-lg"
                    >
                      <Plus size={24} />
                      Count
                    </button>
                    <button
                      onClick={reset}
                      className="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-4 px-4 rounded-xl transition-colors duration-200 flex items-center justify-center active:scale-95 transform"
                    >
                      <RotateCcw size={20} />
                    </button>
                    <button
                      onClick={() => setShowStats(!showStats)}
                      className="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-4 px-4 rounded-xl transition-colors duration-200 flex items-center justify-center active:scale-95 transform"
                    >
                      <TrendingUp size={20} />
                    </button>
                  </div>

                  {showStats && (
                    <div className={`mb-4 p-4 ${theme === 'dark' ? 'bg-slate-600' : 'bg-blue-50'} border ${theme === 'dark' ? 'border-slate-500' : 'border-blue-200'} rounded-xl`}>
                      <div className={`text-sm font-medium ${theme === 'dark' ? 'text-blue-300' : 'text-blue-700'} mb-3`}>
                        <Award size={16} className="inline mr-1" />
                        Session History
                      </div>
                      {sessionHistory.length > 0 ? (
                        <div className="space-y-2 max-h-32 overflow-y-auto">
                          {sessionHistory.slice(-5).reverse().map((session, idx) => (
                            <div key={idx} className={`text-xs ${theme === 'dark' ? 'text-blue-300' : 'text-blue-600'} flex justify-between`}>
                              <span>{session.mantra.substring(0, 20)}...</span>
                              <span>{session.time} ({session.duration}m)</span>
                            </div>
                          ))}
                        </div>
                      ) : (
                        <p className={`text-xs ${theme === 'dark' ? 'text-blue-300' : 'text-blue-600'}`}>Complete a round to see history</p>
                      )}
                    </div>
                  )}

                  {count === 0 && rounds > 0 && (
                    <div className={`mb-4 p-4 ${theme === 'dark' ? 'bg-slate-600' : 'bg-gradient-to-r from-green-50 to-emerald-50'} border ${theme === 'dark' ? 'border-slate-500' : 'border-green-200'} rounded-xl`}>
                      <div className={`${theme === 'dark' ? 'text-green-300' : 'text-green-800'} font-semibold`}>üéâ Round {rounds} Completed!</div>
                      <div className={`${theme === 'dark' ? 'text-green-400' : 'text-green-600'} text-sm`}>
                        {selectedMantra ? `${selectedMantra} - Round completed` : 'Starting new round...'}
                      </div>
                    </div>
                  )}

                  {achievements.length > 0 && (
                    <div className={`mb-4 p-3 ${theme === 'dark' ? 'bg-slate-600' : 'bg-yellow-50'} border ${theme === 'dark' ? 'border-slate-500' : 'border-yellow-200'} rounded-xl`}>
                      <div className={`text-sm ${theme === 'dark' ? 'text-yellow-300' : 'text-yellow-700'} font-medium mb-1`}>
                        <Award size={14} className="inline mr-1" />
                        Achievements Unlocked: {achievements.length}
                      </div>
                    </div>
                  )}

                  {favorites.length > 0 && (
                    <div className={`mb-4 p-3 ${theme === 'dark' ? 'bg-slate-600' : 'bg-pink-50'} border ${theme === 'dark' ? 'border-slate-500' : 'border-pink-200'} rounded-xl`}>
                      <div className={`text-sm ${theme === 'dark' ? 'text-pink-300' : 'text-pink-700'} font-medium mb-1`}>
                        <Star size={14} className="inline mr-1" />
                        Your Favorites ({favorites.length})
                      </div>
                      <div className={`text-xs ${theme === 'dark' ? 'text-pink-400' : 'text-pink-600'}`}>
                        {favorites.slice(0, 2).join(', ')}
                        {favorites.length > 2 && ` +${favorites.length - 2} more`}
                      </div>
                    </div>
                  )}

                  {customMantras.length > 0 && (
                    <div className={`mb-4 p-3 ${theme === 'dark' ? 'bg-slate-600' : 'bg-indigo-50'} border ${theme === 'dark' ? 'border-slate-500' : 'border-indigo-200'} rounded-xl`}>
                      <div className={`text-sm ${theme === 'dark' ? 'text-indigo-300' : 'text-indigo-700'} font-medium mb-1`}>
                        üìù Your Custom Mantras ({customMantras.length})
                      </div>
                      <div className={`text-xs ${theme === 'dark' ? 'text-indigo-400' : 'text-indigo-600'}`}>
                        Saved in IndexedDB and ready to use anytime
                      </div>
                    </div>
                  )}

                  <div className={`text-xs ${theme === 'dark' ? 'text-gray-400' : 'text-gray-500'} text-center leading-relaxed`}>
                    Select your mantra and category, then tap "Count" for each repetition.
                    <br />
                    Automatically resets at 108. Track your progress and achieve milestones! üåü
                  </div>
                </div>
              </div>
            </div>
          );
        }

        ReactDOM.render(<JapaCounter />, document.getElementById('root'));
    </script>
</body>
</html>
